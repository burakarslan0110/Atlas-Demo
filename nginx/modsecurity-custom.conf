# ModSecurity custom configuration for Atlas E-Commerce
# Based on OWASP ModSecurity Core Rule Set

# Enable ModSecurity
SecRuleEngine On

# Request body access
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body access
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temporary directory
SecTmpDir /tmp/
SecDataDir /tmp/

# Debug log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Audit log
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# File uploads
SecUploadDir /tmp/
SecUploadKeepFiles Off

# Custom rules for Atlas E-Commerce

# Allow large JSON payloads for product uploads
SecRule REQUEST_URI "@beginsWith /api/products" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyLimit=52428800"

# Allow large file uploads for product images
SecRule REQUEST_URI "@beginsWith /api/products/.*?/images" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyLimit=52428800"

# Paranoia level
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=1"

# Anomaly scoring
SecAction \
    "id:900110,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# Application-specific exclusions
# Allow GraphQL queries (if needed in future)
SecRule REQUEST_URI "@beginsWith /api/graphql" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100"

# Load OWASP CRS
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
Include /etc/modsecurity.d/owasp-crs/rules/*.conf
